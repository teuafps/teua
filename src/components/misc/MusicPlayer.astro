---
import { musicConfig } from "../../config";
---
<div id="music-player" class="fixed bottom-6 left-6 z-[100] onload-animation hidden md:block group">
    <div class="card-base p-3 flex items-center gap-4 shadow-2xl backdrop-blur-md bg-white/70 dark:bg-black/70 border border-white/20">
        <div class="relative group/disk">
            <div id="music-disk" class="w-12 h-12 rounded-full bg-[var(--primary)] flex items-center justify-center overflow-hidden transition-all duration-500 animate-spin-slow pause-spin shadow-lg border-2 border-white/50">
                <div class="w-4 h-4 rounded-full bg-white dark:bg-black z-10 border-2 border-[var(--primary)]"></div>
            </div>
            <button id="music-toggle" class="absolute inset-0 flex items-center justify-center text-white opacity-0 group-hover/disk:opacity-100 transition-opacity bg-black/40 rounded-full">
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
        </div>
        
        <div class="flex flex-col min-w-[150px]">
            <div class="flex items-center justify-between mb-0.5">
                <span id="music-title" class="text-xs font-bold text-90 truncate max-w-[120px]">Title</span>
                <div class="flex gap-1">
                    <button id="music-prev" class="hover:text-[var(--primary)] transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button id="music-next" class="hover:text-[var(--primary)] transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6zm9-12v12h2V6z"/></svg>
                    </button>
                </div>
            </div>
            <span id="music-artist" class="text-[10px] text-50 mb-1">Artist</span>
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-50" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="0.5" class="w-24 h-1 bg-[var(--primary)]/20 rounded-lg appearance-none cursor-pointer accent-[var(--primary)]">
            </div>
        </div>
    </div>
    
    <audio id="bg-audio" loop></audio>
</div>

<style>
    .animate-spin-slow {
        animation: spin 8s linear infinite;
    }
    .pause-spin {
        animation-play-state: paused;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    input[type='range']::-webkit-slider-runnable-track {
        height: 4px;
    }
</style>

<script is:inline define:vars={{ musicConfig }}>
    (function() {
        if (!musicConfig || !musicConfig.enable || musicConfig.songs.length === 0) return;

        const audio = document.getElementById('bg-audio');
        const toggle = document.getElementById('music-toggle');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const disk = document.getElementById('music-disk');
        const volumeSlider = document.getElementById('volume-slider');
        const musicTitle = document.getElementById('music-title');
        const musicArtist = document.getElementById('music-artist');
        const nextBtn = document.getElementById('music-next');
        const prevBtn = document.getElementById('music-prev');

        let currentIdx = 0;
        let isPlaying = false;

        function loadSong(idx) {
            const song = musicConfig.songs[idx];
            audio.src = song.url;
            musicTitle.textContent = song.title;
            musicArtist.textContent = song.artist;
            if (isPlaying) audio.play();
        }

        function togglePlay() {
            if (isPlaying) {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                disk.classList.add('pause-spin');
            } else {
                audio.play().catch(e => console.log("User interaction required"));
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                disk.classList.remove('pause-spin');
            }
            isPlaying = !isPlaying;
        }

        toggle.addEventListener('click', togglePlay);
        nextBtn.addEventListener('click', () => {
            currentIdx = (currentIdx + 1) % musicConfig.songs.length;
            loadSong(currentIdx);
        });
        prevBtn.addEventListener('click', () => {
            currentIdx = (currentIdx - 1 + musicConfig.songs.length) % musicConfig.songs.length;
            loadSong(currentIdx);
        });

        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value;
        });

        // Initialize
        loadSong(currentIdx);
        audio.volume = volumeSlider.value;
    })();
</script>
